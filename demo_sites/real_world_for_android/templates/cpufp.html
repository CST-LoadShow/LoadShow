<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="UTF-8">
    <title>Program Detection</title>
</head>

<h1>Program Detection</h1>

<body translate="no" >
    <br>
    输入设备名称后，点击Launch开始运行
    <br>
    Device Name: <input id="device_name" type="text" name="name">
    <br>
    Trace number: <input id="repeat_time" type="text" name="name">
    <!-- <button onclick="set_repeat_time()">Set repeat times</button> -->
    <br>
    <pre id="error_report"></pre>
    <br>
    <button onclick="launch()">Launch!</button>
    <br>
    <pre id="results"></pre>
    <script>
        var repeat_time=1;
        function stall_function(arg) {
            var array = new Uint32Array(arg * 50);
            var start = performance.now();
            for (var k = 1; k <= 20000; k++) {
                crypto.getRandomValues(array);
            }
            var end = performance.now();
            return end - start;
        }

        function stall_function2(arg) {
            var x = 0.5;
            var start = performance.now();
            for (var k = 1; k <= (arg * 5 + 10) * 10000; k++) {
                x = Math.sin(x);
                x = Math.cos(x);
            }
            var end = performance.now();
            return end - start;
        }

        function stall_function3(arg) {
            var array = new Uint32Array(arg * 5 + 10);
            crypto.getRandomValues(array);
            var start = performance.now();
            var start = performance.now();
            for (var k = 1; k <= 2000; k++) {
                var sorted_data = [...array].sort((a, b) => a - b);
            }
            var end = performance.now();
            return end - start;
        }
        
        // regex
        function stall_function4(arg) {
            var re = /ab+c/;
            var test_string = "a".repeat(arg * 100) + "b".repeat(arg * 100) + "c".repeat(arg * 100);
            var start = performance.now();
            for (var k = 1; k <= 10000; k++) {
                var myArray = re.exec(test_string);
            }
            var end = performance.now();
            return end - start;
        }

        var function_list = [stall_function, stall_function2, stall_function3, stall_function4];

        function FPGeneration(n, m) {
            var stallTime;
            var fp = new Array(n);
            for (var i = 0; i < fp.length; i++){
                fp[i] = new Array(m).fill(0);
            }
            stall_function(10);
            stall_function2(10);
            stall_function3(10);
            stall_function4(10);
            for (var i = 0; i < m; i++) {
                for (var j = 0; j < n; j++) {
                    // console.time();
                    stallTime = function_list[j & 3](j);
                    // console.log(j, stallTime);
                    // console.timeEnd();
                    fp[j][i] = stallTime;
                }
            }
            return fp;
        }

        function print_fp(fp) {
            resString = "";
            for (var i = 0; i < fp.length; i++) {
                for (var j = 0; j < fp[i].length; j++) {
                    resString += fp[i][j].toFixed(1) + ",";
                }
                resString = resString.slice(0, -1);
                resString += "\n";
            }
            document.getElementById("results").innerText += resString;
            send_to_server(resString);
        }

        function send_to_server(msg) {
            var xhr = new XMLHttpRequest();
            if (xhr) {
                xhr.open("POST", '/get_fingerprint', true);
                xhr.setRequestHeader('content-Type', 'application/x-www-form-urlencoded');
                xhr.send("device_name=" + device_name + "&fingerprint=" + msg);
            }
        }

        function set_device_name() {
            device_name = document.getElementById("device_name").value;
            if (device_name.length == 0) {
                document.getElementById("error_report").innerText = "Please input device label";
                return false;
            }
            return true;
        }

        function set_repeat_time() {
            tmp = document.getElementById("repeat_time").value;
            if (tmp.length == 0) {
                document.getElementById("error_report").innerText = "Please input repeat times";
                return false;
            }
            repeat_time = parseInt(document.getElementById("repeat_time").value);
            return true;
        }

        function launch() {
            if (!set_device_name() || !set_repeat_time()) {
                alert("Device name or repeat time empty");
            } else {
                document.getElementById("results").innerText = "";
                for (var i = 1; i <= repeat_time; i++) {
                    document.getElementById("results").innerText += "Fingerprint " + i + ":\n";
                    console.log(i);
                    var res = FPGeneration(16, 64);
                    print_fp(res);
                }
                alert("finish");
            }
        }
    </script>
</body>
